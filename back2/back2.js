var t1 = `PART II READING COMPREHENSION (45MIN)
SECTION A MULTIPLE CHOICE QUESTIONS
In this section there are three passages followed by fourteen multiple choice questions. For each multiple
choice question, there are four suggested answers marked A, B, C and D. Choose the one that you think is
the best answer and mark your answers on ANSWER SHEET TWO.
PASSAGE ONE
(1) Buck did not read the newspapers, or he would have known that trouble was brewing, not alone for
himself, but for every tidewater dog, strong of muscle and with warm, long hair, from Puget Sound to San
Diego. Because men, groping in the Arctic darkness, had found a yellow metal, and because steamship and
transportation companies were booming the find, thousands of men were rushing into the Northland. These men
wanted dogs, and the dogs they wanted were heavy dogs, with strong muscles by which to toil, and furry coats
to protect them from the frost.
(2) Buck lived at a big house in the sun-kissed Santa Clara Valley. Judge Miller's place, it was called. It
stood back from the road, half hidden among the trees, through which glimpses could be caught of the wide cool
veranda that ran around its four sides. The house was approached by gravelled driveways which wound about
through wide-spreading lawns and under the interlacing boughs of tall poplars. At the rear things were
on even a more spacious scale than at the front. There were great stables, where a dozen grooms and boys held
forth, rows of vine-clad servants' cottages, an endless and orderly array of outhouses, long grape arbors, green
pastures, orchards, and berry patches. Then there was the pumping plant for the artesian well, and the big
cement tank where Judge Miller's boys took their morning plunge and kept cool in the hot afternoon.
(3) And over this great demesne Buck ruled. Here he was born, and here he had lived the four
years of his life. It was true, there were other dogs. There could not but be other dogs on so vast a place, but
they did not count. They came and went, resided in the populous kennels, or lived obscurely in the recesses of
the house after the fashion of Toots, the Japanese pug, or Ysabel, the Mexican hairless, --strange creatures that
rarely put nose out of doors or set foot to ground. On the other hand, there were the fox terriers, a score of them
at least, who yelped fearful promises at Toots and Ysabel looking out of the windows at them and protected by a
legion of housemaids armed with brooms and mops.
(4) But Buck was neither house-dog nor kennel-dog. The whole realm was his. He plunged into the
swimming tank or went hunting with the Judge's sons; he escorted Mollie and Alice, the Judge's daughters, on
long twilight or early morning rambles; on wintry nights he lay at the Judge's feet before the roaring library fire;
he carried the Judge's grandsons on his back, or rolled them in the grass, and guarded their footsteps through
wild adventures down to the fountain in the stable yard, and even beyond, where the paddocks were, and the
berry patches. Among the terriers he stalked imperiously, and Toots and Ysabel he utterly ignored, for he was
king, --king over all creeping, crawling, flying things of Judge Miller's place, humans included.
(5) His father, Elmo, a huge SL Bernard, had been the Judge's inseparable companion, and Buck bid fair
to follow in the way of his father. He was not so large, --he weighed only one hundred and forty pounds, --for
his mother, Shep, had been a Scotch shepherd dog. Nevertheless, one hundred and forty pounds, to which was
added the dignity that comes of good living and universal respect, enabled him to carry himself in right royal
fashion. During the four years since his puppyhood he had lived the life of a sated aristocrat; he had
a fine pride in himself, was even a trifle egotistical, as country gentlemen sometimes become because of their
insular situation. But he had saved himself by not becoming a mere pampered house-dog. Hunting and kindred
outdoor delights had kept down the fat and hardened his muscles; and to him, as to the cold-tubbing races, the
love of water had been a tonic and a health preserver.
(6) And this was the manner of Buck in the fall of 1897, when the Klondike strike dragged men from all
the world into the frozen North. But Buck did not read the newspapers, and he did not know that Manuel, one
of the gardener's helpers, was an undesirable acquaintance. Manuel had one besetting sin. He loved to play
lottery. Also, in his gambling, he had one besetting weakness--faith in a system ; and this made his damnation
certain. For to play a system requires money, while the wages of a gardener's helper do not lap over the needs
of a wife and numerous progeny.
11. The description in Para. 2is meant to introduce ____
A. the social background of the story B. the layout of Judge Miller's place
C. the good living conditions of Buck D. the contrast between Buck and others
12. Which of the following BEST explains Buck's superiority over other dogs?
A. Buck lived in the house longer than other dogs.
B. Kennel-dogs were not allowed to walk around.
C. Buck was the favorite dog of the house owner.
D. House-dogs were well protected by housemaids.
13. When describing Buck, the author's tone is ____
A. humorous B. sarcastic C. critical D. friendly
14. What follows the last paragraph of the passage will most probably narrate ____
A. how the lottery system worked in 1897 B. what was written in the newspapers
C. how Manuel managed to win lottery D. the troubles Manuel brought to Buck
PASSAGE TWO
(1) Early this winter, the hundreds of climbers making plans for spring-summit attempts on Mount
Qomolangma suddenly faced a new set of rules. In December, the Nepalese government decreed that it would no
longer issue permits to blind, solo, or double-amputee mountaineers for any of its high peaks. Furthermore, all
expeditions would have to employ at least one Sherpa and would be forbidden from using
helicopters to reach high camps.
(2) The regulations fit a pattern established by Nepal's Ministry of Tourism, which in the past few years
has issued a series of proclamations--climbers must announce plans to set records, trekkers must carry location
beacons--that suggest improved management of its high-altitude peaks. Each new declaration generates a rush of
international news reports about authorities making strides toward addressing safety at the top of the world. The
truth is a lot more complicated.
(3) Mountaineering is big business in Nepal. Industry experts estimate that it generates some $26.5
million in tourism income each year, with around $ 11 million of that corning from Qomolangma climbers
alone. The enduring obsession of the Western media with tragic deaths on these far-off snowy peaks has resulted
in a lot offree marketing. Nepal's Ministry of Tourism, perhaps concerned that all the morbid tales might drive
climbers to Qomolangma's less used Chinese side, has gained some control of that narrative by broadcasting
more positive developments through the Nepalese press. But the rules announced to date would do nothing to
mitigate the dangers of climbing Qomolangma even if Nepal had the resources and conviction to enforce them,
which it doesn't.
(4) Making a huge, hugely popular mountain safer is possible. On Alaska's Denali, fulltime climbing
rangers conduct safety checks of many teams and are mobilized for rescue operations. On Argentina's
Aconcagua, rangers patrol all high camps, and until recently, permit fees included the cost of helicopter
rescues. Adopting similar policies in Nepal would be a good start. A longer list of true reforms would include
ordering all climbers to have previously summited a 7,000-meter peak, requiring non-guides working above Base
Camp to take a course at the Khumbu Climbing Center (hundreds have done so since it was founded in 2003),
and capping the total number of climbers on the mountain at 500per season, including support staff. That last
policy would both reduce dangerous crowding and help keep the mountain clean.
(5) Unfortunately, these kinds of rules are less likely than ever to be instituted on Qomolangma, owing to
the rise of budget guiding companies. Beginning in the early 1990s, Western outfitters established commercial
mountaineering on the Nepal side of the peak by attracting clients willing to pay as much as $65,000 to be
guided to the summit. â€¢ That business model dominated for more than two decades, bringing an estimated 9,000
paying climbers to Base Camp. Consequently, Qomolangma earned a reputation as a magnet for the rich,
ambitious, and inexperienced.
(6) As in many markets, savvy entrepreneurs saw opportunities for disruption. Lower-cost guiding
companies, some founded by Westerners and others by Nepalese, slowly gained attraction by offering
Qomolangma climbs for as little as a third of the going rate among high-end outfitters. Then came 2014, when
16Sherpas died after a serac collap sed onto the Khumbu Icefall, part of the main route from Base Camp
to Camp I. In the wake of that tragedy, a small group of Sherpas demanded that the Nepalese government
establish regulations that would improve working conditions, increase pay, boost life-insurance coverage, and
provide a funeral stipend. illtimately, Sherpas received a bit more insurance-the minimum payout was doubled
from $5,500 to $11,000--but not much else.
(7) Partly in response to media attention of these events, Nepali-owned guiding companies have continued
to gain influence and market share on Qomolangma. The shift away from foreign control of the mountain is
welcomed by many in the climbing community. Another positive development : lower-cost operators are
increasing diversity on Qomolangma, attracting climbers from China's and India's burgeoning middle classes
with aggressive pricing. Based on numbers from the Himalayan Database, in 2010, four Indian and eight
Chinese climbers attempted the mountain, just 6percent of the total. Last year, Chinese and Indian clients
accounted for 60of the 199Nepal-side summits.
(8) Unfortunately, in the absence of substantive government oversight, some of the budget companies are
making Qomolangma more dangerous by flooding the already overcrowded route with novice climbers led by
inexperienced guides. Any operators charging less for guided climbs are prone to bolster profits through scale,
booking dozens of clients on expeditions. (The most respected outfitters set a maximum of ten.) Putting aside
2014's tragedy and 2015's earthquake-induced avalanche, which killed at least 17people at Base Camp, 12 of
the 17climber deaths on the South Col route between 2011 and 2017appear to have been clients of budget
outfitters.
(9) During last year's peak season, Kathmandu-based Seven Summit Treks, known for bringing large
groups of climbers to Qomolangma, allegedly promoted a young support staffer named Sange to guideQo
molangma and assigned him to an older Pakistani client. The pair reached the summit late in the day and got
into trouble on their descent. They had to be rescued by experienced Sherpas from another Nepalese outfitter.
Sange later had all his fingers amputated due to severe frostbite.
(10) Veteran guides are reacting to all this in different ways. Adrian Ballinger, founder of the California..
outfitter Alpenglow, has abandoned the Nepal side of Qomolangma and is instead leading teams from China. As
he explained it, the higher risk from natural dangers (avalanches, seracs, crevasses ), the low standards of other
outfitters, and Nepal's mismanagement add up to an unacceptable environment. Several other prominent guides
have come to the same conclusion, including Austrian Lukas Furtenbach. Others are staying put. International
Mountain Guides co-owner Eric Simonson, whose first expedition on Qomolangma was in 1982, insists that
upgrades in route-making through the Khumbu Icefall, and the establishment of dual ropes in areas prone to
bottlenecks, have made the Nepal side safer, even as the crowds have grown.
(11 ) Qomolangma remains the ultimate conquest for many climbers. And while most embrace the risk of
high-altitude mountaineering, few understand that the biggest dangers are all too often the result of economics,
not the forces of nature. IBtimately, the top priority of many tourism officials and outfitters isn't safety. It's the
bottom line.
15. Which of the following is NOT a safety measure according to Paras. 1&2?
A. Employment of Sherpas on all expeditions. B. Use of helicopters to get to high camps.
C. Announcement of climbers' plans. D. Permits issued to able-bodied trekkers.
16. What is the main purpose of Para. 4?
17.
A. To list the necessary conditions.
C. To make recommendations with examples.
What can be inferred from Paras. 5&6?
B. To show the policies in other regions.
D. To emphasize the importance of training.
A. Budget guiding companies may fail to ensure climbers'safety.
B. Western outfitters are more reliable than Nepalese companies.
C. Working conditions for Sherpas have been much improved.
D. Cost of climbing business has been greatly reduced recently.
18. The case of Sange in Para. 9is cited to illustrate ____
A. the importance of guides B. the complexity of climbing
C. the required health conditions D. the problems of budget outfitters
19. The function of " Others are staying put " in Para. 10is to ____
A. list factors B. show contrast
C. introduce a point D. provide an example
PASSAGE THREE
(1) Vast stretches of central Asia feel eerily uninhabited. Fly at 30,000 feet over the southern part of the
former Soviet Union and there are long moments when no town or road or field is visible from your window.
The landscape of stark desert, trackless steppe, and rugged mountains seems to swallow up anything
human. It is little surprise, then, that this region remains largely unknown to most archaeologists.
(2) Wandering bands and tribes roamed this immense area for 5,000 years, herding goat, sheep, cattle,
and horses across immense steppes, through narrow valleys, and over high snowy passes. They left occasional
tombs that survived the ages, and on rare occasions settled down and built towns or even cities. But for the most
part, these peoples left behind few physical traces of their origins, beliefs, or ways of life. What we know of
these nomadic pastoralists comes mainly from their periodic forays into India, the Middle East, and China,
where they often wreaked havoc and earned a fearsome reputation as enemies of urban life.
(3) In the past century, scholars criticized these people as destructive, dismissed them as marginal, or, at
best, cast them as a harsh tonic for restoring vigor to decaying and soft agricultural societies from ancient
Mesopotamia to Imperial Rome to Han China. In the 1950's, a British archaeologist Mortimer Wheeler blamed
the aggressive, chariot-driving Aryans who swept in from the steppes for the demise of the peaceful Indus River
civilization after 1800 B.C., though later archaeologists dismissed that claim.
(4) But Michael Frachetti, a young archaeologist at Washington University in St. Louis, takes the radical
view that Central Asians were early midwives in the birth of civilization rather than a destructive force. Frachetti
argues that ancient pastoralists living in the third millennium B.C., at the time of the first great cities of
Mesopotamia, Egypt, and the Indus, created a network stretching across thousands of miles that passed along
goods, technologies, and ideas central to urban life. He believes they helped create civilization rather than
hindering it.
(5) Most archaeological work in Central Asia during the past century has focused on the open and rolling
plains that stretch from the Black Sea to Manchuria. These steppes only came to life after 2000 B.C., when
horse domestication and riding suddenly turned a forbidding landscape for pedestrians into a natural highway of
grass.
(6) By contrast, the areas. to the south of the steppes have long been dismissed as backwaters of history. In
the past, these southern mountains and deserts were considered too remote, rugged, and inhospitable to have
played a role in early migrations or the emergence of urban life. The Karakum Desert, where it might rain once
in a decade, covers nearly two-thirds of today's Turkmenistan, while the perpetually snow-covered Tian Shan
Mountains of western China and eastern Kyrgyzstan soar 24,000 feet into the thin air. It is there that Frachetti
and a new generation of archaeologists from the United States and Central Asian nations are discovering evidence
of a network of pastoralists who thrived centuries before hooves resounded on the steppes to the north. These
forgotten peoples may have carried such markers of civilization as ceramics and grains across thousands of miles,
two millennia before the Silk Road linked the Roman Empire with Han China. Frachetti argues that the new data
emerging from the region force archaeologists to rethink their ideas about trade across Eurasia during the Bronze
Age, when the first civilizations were taking form to the east, south, and west.
(7) Frachetti, who has studied modem-day pastoralists in such unforgiving landscapes as the Sahara and
Scandinavia, was drawn to the southern region of Central Asia for its environmental diversity Â· of desert,
grassland, and meadows. Instead of a wasteland, he saw an ideal landscape for enterprising herders who wanted
to pasture their animals in all seasons. Together with his colleagues, Frachetti began digging a decade ago in the
Dzhungar Mountains of Kazakhstan. Covering nearly 500square miles, this region lies between the Tian Shan
and Altai mountain ranges, and boasts sharp peaks topping 12,000 feet, as well as harsh desert. At a site near a
village called Begash, on a flat terrace enclosed by steep canyon walls alongside a small stream, the team
uncovered the foundations of simple stone structures along with an array of potsherds and bronze
and stone artifacts in stone-lined oval and rectangular tombs. The earliest layers at Begash date to at least as early
as 2500 B.C., based on alpha magnetic spectrometry dating of organic remains, says Frachetti. One woman
was laid to rest with a bell-shaped hooked bronze earring around 1700 B.C., according to electron spin resonance
dating. Similar earrings are only found several centuries later some 600miles to the north on the Siberian
steppes, hinting at styles that moved north over time.
(8) More surprisingly, the excavators found wheat, which was first domesticated in the Fertile Crescent of
the Middle East, and broomcorn millet that was first widely grown in northern China. The grains were used
ritually in a burial, and radiocarbon dating of the remains dates them to about 2200 B.C., making them the
oldest known domesticated grains in Central Asia. The people of Begash may not have grown either grain-there
are no grinding stones, a sign of grain preparation-but instead received it via trade networks stretching from the
Near East to China.
(9) Dorian Fuller, a leading expert in ancient grains based at University College London, calls the finds
" important and well dated. " He adds that Chinese crops such as millet began to appear in southwest Asia around
1900 B.C., a few centuries after they reached Begash, which could mean the passage through the mountain
regions was a means of gradual transmission from east to west. Frachetti speculates that the grains may have been
acquired from other tribes and used for ritual purposes, and then perhaps were passed on in turn to other pastoral
peoples.
(10) What makes the Begash discoveries so important is that previously this region was assumed to have
been a land of scattered foragers until steppe peoples trickled down into the area's valleys and
mountain ranges after 2000 B.C. But it is becoming evident that the people of Begash were not simple foragers,
but sophisticated pastoralists who tended their flocks, much as people in the area still do today. The inhabitants
did not begin to use horses until well into the second millennium B.C., and the varieties of sheep and goat found
here today appear to be related to the varieties first domesticated thousands of years before in western Iran, near
ancient Mesopotamia. This indicates that Begash was " at the crossroads of extremely wide networks among
Eurasian communities by the third millennium B.C., " asserts Frachetti. That doesn't mean that traders traversed
thousands of miles in this early period. Instead, the archaeologist envisions pastoralists taking their flocks to
higher pastures in the summer, where they encountered neighbors from other valleys doing the same. Thus,
ideas and technologies might have passed gradually through the mountain corridors of southern Central Asia.
This corridor, Frachetti believes, may have been a key conduit for Bronze Age developments farther into East
Asia and Mongolia.
20. According to Paras.1&2, the nomadic pastoralists were depicted as ____ people.
A. peace-loving
C. urban
B. mysterious
D. friendly
21. According to the passage, what made the steppes accessible to travelers ?
A. Horse domestication.
C. Climate change.
B. Emergence of towns.
D. Population movement.
22. Frachetti was initially interested in the areas to the south of the steppes because of ____
A. their harsh climate and terrain B. their role in the emergence of urban life
C. their varied geographical features D. their location in the trade route to the north
23. Which of the following statements about the wheat and millet found in Begash is CORRECT?
A. They were early signs of agriculture there.
C. They were mainly used in religious rituals.
B. They were the result of trading with China.
D. They were probably given by other tribes.
24. What is the significance of the Begash discoveries according to Para. 10?
A. People in the area lived basically as hunters.
B. New views about the region came into being.
C. Begash was at the center of the trading network.
D. Begash was part of the Eurasian community.
SECTION B SHORT ANSWER QUESTIONS
In this section there are eight short answer questions based on the passages in Section A. Answer each
question in NO MORE THAN TEN WORDS in the space provided on ANSWER SHEET TWO.
PASSAGE ONE
25. Why were dogs wanted in the Northland?
26. Use adjectives to describe Buck's physical appearance and personality. You should write at least TWO
adjectives for each.
PASSAGE TWO
27. What does the author think of the rules announced so far?
28. Why is there a limit on the total number of climbers per season?
29. What does " to bolster profits through scale" mean in Para.8?
PASSAGE THREE
30. What does the statement " Central Asians were early midwives in the birth of civilization" mean in Para.4?
31. What examples are used to illustrate the harsh environment in the south of the steppes in Para.6?
32. What did the discovery of the earrings in the tombs and those found later indicate (Para.7)?`;

var t2 = `Abstract
We introduce Perceus, an algorithm for precise reference
counting with reuse and specialization. Starting from a func-
tional core language with explicit control-flow, Perceus emits
precise reference counting instructions such that (cycle-free)
programs are garbage free, where only live references are re-
tained. This enables further optimizations, like reuse analysis
that allows for guaranteed in-place updates at runtime. This
in turn enables a novel programming paradigm that we call
functional but in-place (FBIP). Much like tail-call optimiza-
tion enables writing loops with regular function calls, reuse
analysis enables writing in-place mutating algorithms in a
purely functional way. We give a novel formalization of ref-
erence counting in a linear resource calculus, and prove that
Perceus is sound and garbage free. We show evidence that
Perceus, as implemented in Koka, has good performance and
is competitive with other state-of-the-art memory collectors.
Keywords: Reference Counting, Algebraic Effects, Handlers
1 Introduction
Reference counting [7], with its low memory overhead and
ease of implementation, used to be a popular technique for
automatic memory management. However, the field has
broadly moved in favor of generational tracing collectors [31],
partly due to various limitations of reference counting, in-
cluding cycle collection, multi-threaded operations, and ex-
pensive in-place updates.
In this work we take a fresh look at reference counting. We
consider a programming language design that gives strong
compile-time guarantees in order to enable efficient refer-
ence counting at run-time. In particular, we build on the
pioneering reference counting work in the Lean theorem
prover [46], but we view it through the lens of language
design, rather than purely as an implementation technique.
We demonstrate our approach in the Koka language [23,
25]: a functional language with mostly immutable data types
together with a strong type and effect system. In contrast
âˆ—The first two authors contributed equally to this work.
to the dependently typed Lean language, Koka is general-
purpose, with support for exceptions, side effects, and muta-
ble references via general algebraic effects and handlers [39,
40]. Using recent work on evidence translation [50â€“52], all
these control effects are compiled into an internal core lan-
guage with explicit control flow. Starting from this functional
core, we can statically transform the code to enable efficient
reference counting at runtime. In particular:
â€¢ Due to explicit control flow, the compiler can emit precise
reference counting instructions where a (non-cyclic) ref-
erence is dropped as soon as possible. We call this garbage
free reference counting as only live data is retained (Â§ 2.2).
â€¢ We show that precise reference counting enables many
optimizations, in particular drop specialization which re-
moves many reference count operations in the fast path
(Section 2.3), reuse analysis which updates (immutable)
data in-place when possible (Section 2.4), and reuse spe-
cialization which removes many in-place field updates
(Section 2.5). The reuse analysis shows the benefit of a
holistic approach: even though the surface language has
immutable data types with strong guarantees, we can use
dynamic run-time information, e.g. whether a reference is
unique, to update in-place when possible.
â€¢ The in-place update optimization is guaranteed, which
leads to a new programming paradigm that we call FBIP:
functional but in-place (Section 2.6). Just like tail-call op-
timization lets us write loops with regular function calls,
reuse analysis lets us write in-place mutating algorithms
in a purely functional way. We showcase this approach
by implementing a functional version of in-order Morris
tree traversal [35], which is stack-less, using in-place tree
node mutation via FBIP.
â€¢ We present a formalization of general reference counting
using a novel linear resource calculus, ðœ†
1
, which is closely
based on linear logic (Section 3), and we prove that ref-
erence counting is sound for any program in the linear
resource calculus. We then present the Perceus1
algorithm
1Perceus, pronounced per-see-us, is a loose acronym of â€œPrEcise Reference
Counting with rEUse and Specializationâ€.
MSR-TR-2020-42, Nov 22, 2020, Alex Reinking, Ningning Xie, Leonardo de Moura, and Daan Leijen
as a deterministic syntax-directed version of ðœ†
1
, and prove
that it is both sound (i.e. never drops a live reference), and
garbage free (i.e. only retains reachable references).
â€¢ We demonstrate Perceus by providing a full implementa-
tion for the strongly typed functional language Koka [1].
The implementation supports typed algebraic effect han-
dlers using evidence translation [51] and compiles into
standard C11 code. The use of reference counting means
no runtime system is needed and Koka programs can read-
ily link with other C/C++ libraries.
â€¢ We show evidence that Perceus, as implemented for Koka,
competes with other state-of-the-art memory collectors
(Section 4). We compare our implementation in alloca-
tion intensive benchmarks against OCaml, Haskell, Swift,
and Java, and for some benchmarks to C++ as well. Even
though the current Koka compiler does not have many
optimizations (besides the ones for reference counting), it
has outstanding performance compared to these mature
systems. As a highlight, on the tree insertion benchmark,
the purely functional Koka implementation is within 10%
of the performance of the in-place mutating algorithm in
C++ (using std::map [13]).
Even though we focus on Koka in this paper, we believe that
Perceus, and the FBIP programming paradigm we identify,
are both broadly applicable to other programming languages
with similar static guarantees for explicit control flow.
There is an accompanying technical report [41] containing
all the proofs and further benchmark results.
2 Overview
Compared to a generational tracing collector, reference count-
ing has low memory overhead and is straightforward to
implement. However, while the cost of tracing collectors
is linear in the live data, the cost of reference counting is
linear in the number of reference counting operations. Op-
timizing the total cost of reference counting operations is
therefore our main priority. There are at least three known
problems that make reference counting operations expensive
in practice and generally inferior to tracing collectors:
â€¢ Concurrency: when multiple threads share a data structure,
reference count operations need to be atomic, which is
expensive.
â€¢ Precision: common reference counted systems are not pre-
cise and hold on to objects too long. This increases memory
usage and prevents aggressive optimization of many ref-
erence count operations.
â€¢ Cycles: if object references form a cycle, the runtime needs
to handle them separately, which re-introduces many of
the drawbacks of a tracing collector.
We handle each of these issues in the context of an eager,
functional language using immutable data types together
with a strong type and effect system. For concurrency, we
precisely track when objects can become thread-shared (Sec-
tion 2.7.2). For precision, we introduce Perceus, our algorithm
for inserting precise reference counting operations that can
be aggressively optimized. In particular, we eliminate and
fuse many reference count operations with drop specializa-
tion (Section 2.3), turn functional matching into in-place
updates with reuse analysis (Section 2.4), and minimize field
updates with reuse specialization (Section 2.5).
Finally, although we currently do not supply a cycle col-
lector, our design has two mitigations that reduces the oc-
currences of cycles in the first place. First, (co)inductive data
types and eager evaluation prevent cycles outside of explicit
mutable references, and it is statically known where cycles
can possibly be introduced in the code (Section 2.7.4). Second,
being a mostly functional language, mutable references are
not often used â€“ moreover, reuse analysis greatly reduces the
need for them since in-place mutation is typically inferred.
The reference count optimizations are our main contribu-
tion and we start with a detailed overview in the following
sections, ending with details about how we mitigate the
impact of concurrency and cycles.
2.1 Types and Effects
We start with a brief introduction to Koka [23, 25] â€“ a strongly
typed, functional language that tracks all (side) effects. For
example, we can define a squaring function as:
fun square( x : int ) : total int { x * x }
Here we see two types in the result: the effect type total and
the result type int. The total type signifies that the func-
tion can be modeled semantically as a mathematically total
function, which always terminates without raising an excep-
tion (or having any other observable side effect). Effectful
functions get more interesting effect types, like:
fun println( s : string ) : console ()
fun divide( x : int, y : int ) : exn int
where println has a console effect and divide may raise an
exception (exn) when dividing by zero. It is beyond the scope
of this paper to go into full detail, but a novel feature of Koka
is that it supports typed algebraic effect handlers which can
define new effects like async/await, iterators, or co-routines
without needing to extend the language itself [24â€“26].
Koka uses algebraic data types extensively. For example,
we can define a polymorphic list of elements of type a as:
type listâŸ¨aâŸ© {
Cons( head : a, tail : listâŸ¨aâŸ© )
Nil
}
We can match on a list to define a polymorphic map function
that applies a function f to each element of a list xs:
fun map( xs : listâŸ¨aâŸ©, f : a -> e b ) : e listâŸ¨bâŸ© {
match(xs) {
Cons(x,xx) -> Cons(f(x), map(xx,f))
Nil -> Nil
}
}
Here we transform the list of generic elements of type a to
a list of generic elements of type b. Since map itself has no
Perceus: Garbage Free Reference Counting with Reuse MSR-TR-2020-42, Nov 22, 2020,
intrinsic effect, the overall effect of map is polymorphic, and
equals the effect e of the function f as it is applied to every
element. The map function demonstrates many interesting
aspects of reference counting and we use it as a running
example in the following sections.
2.2 Precise Reference Counting
An important attribute that sets Perceus apart is that it is pre-
cise: an object is freed as soon as no more references remain.
By contrast, common reference counting implementations
tie the liveness of a reference to its lexical scope, which might
retain memory longer than needed. Consider:
fun foo() {
val xs = list(1,1000000) // create large list
val ys = map(xs, inc) // increment elements
print(ys)
}
Many compilers emit code similar to:
fun foo() {
val xs = list(1,1000000)
val ys = map(xs, inc)
print(ys)
drop(xs)
drop(ys)
}
where we use a gray background for generated operations.
The drop(xs) operation decrements the reference count of
an object and, if it drops to zero, recursively drops all chil-
dren of the object and frees its memory. These â€œscoped life-
timeâ€ reference counts are used by the C++ shared_ptrâŸ¨TâŸ©
(calling the destructor at the end of the scope), Rustâ€™s RcâŸ¨TâŸ©
(using the Drop trait), and Nim (using a finally block to call
destroy) [53]. It is not required by the semantics, but Swift
typically emits code like this as well [14].
Implementing reference counting this way is straightfor-
ward and integrates well with exception handling where the
drop operations are performed as part of stack unwinding.
But from a performance perspective, the technique is not
always optimal: in the previous example, the large list xs is
retained in memory while a new list ys is built. Both exist for
the duration of print, after which a long, cascading chain of
drop operations happens for each element in each list.
Perceus takes a more aggressive approach where owner-
ship of references is passed down into each function: now
map is in charge of freeing xs, and ys is freed by print: no
drop operations are emitted inside foo as all local variables
are consumed by other functions, while the map and print
functions drop the list elements as they go. In this example,
Perceus generates the code for map as given in Figure 1b. In
the Cons branch, first the head and tail of the list are dupped,
where a dup(x) operation increments the reference count
of an object and returns itself. The drop(xs) then frees the
initial list node. We need to dup f as well as it is used twice,
while x and xx are consumed by f and map respectively.
At first blush, this seems more expensive than the scoped
approach but, as we will see, this change enables many fur-
ther optimizations. More importantly, transferring owner-
ship, rather than retaining it, means we can free an object
immediately when no more references remain. This both
increases cache locality and decreases memory usage. For
map, the memory usage is halved: the list xs is deallocated
while the new list ys is being allocated.
2.3 Drop Specialization
Once we change to precise, ownership-based reference count-
ing, there are many further optimization opportunities. After
the initial insertion of dup and drop operations, we perform a
drop specialization pass. The basic drop operation is defined
in pseudocode as:
fun drop( x ) {
if (is-unique(x)) then drop children of x; free(x)
else decref(x)
}
and drop specialization essentially inlines the drop opera-
tion specialized at a specific constructor. Figure 1c shows
the drop specialization of our map example. Note that we
only apply drop specialization if the children are used, so no
specialization takes place in the Nil branch.
Again, it appears we made things worse with extra opera-
tions in each branch, but we can perform another transfor-
mation where we push down dup operations into branches
followed by standard dup/drop fusion where corresponding
dup/drop pairs are removed. Figure 1d shows the code that
is generated for our map example.
After this transformation, almost all reference count op-
erations in the fast path are gone. In our example, every
node in the list xs that we map over is unique (with a refer-
ence count of 1) and so the if (is-unique(xs)) test always
succeeds, thus immediately freeing the node without any
further reference counting.
2.4 Reuse Analysis
There is more we can do. Instead of freeing xs and imme-
diately allocating a fresh Cons node, we can try to reuse xs
directly as first described by Ullrich and de Moura [46]. Reuse
analysis is performed before emitting the initial reference
counting operations. It analyses each match branch, and tries
to pair each matched pattern to allocated constructors of
the same size in the branch. In our map example, xs is paired
with the Cons constructor. When such pairs are found, and
the matched object is not live, we generate a drop-reuse
operation that returns a reuse token that we attach to any
constructor paired with it:
fun map( xs, f ) {
match(xs) {
Cons(x,xx) {
val ru = drop-reuse(xs)
Cons@ru( f(x), map(xx, f))
}
Nil -> Nil
}`;